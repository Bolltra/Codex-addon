#!/usr/bin/with-contenv bashio
set -euo pipefail

bashio::log.info "Preparing Codex CLI environment."

HOME_DIR="${CODEX_HOME:-/config/codex}"
NPM_PREFIX="${HOME_DIR}/.npm-global"
NPM_CACHE="${HOME_DIR}/.npm-cache"
BIN_DIR="${NPM_PREFIX}/bin"

mkdir -p "${HOME_DIR}" "${BIN_DIR}" "${NPM_CACHE}"
chown root:root "${HOME_DIR}"
chmod 700 "${HOME_DIR}"

export CODEX_HOME="${HOME_DIR}"
export NPM_CONFIG_PREFIX="${NPM_PREFIX}"
export NPM_CONFIG_CACHE="${NPM_CACHE}"
export PATH="${BIN_DIR}:${PATH}"

if [ ! -x "${BIN_DIR}/codex" ]; then
    bashio::log.info "Installing Codex CLI persistently under ${BIN_DIR}."
    if HOME="${HOME_DIR}" npm install -g @openai/codex >/tmp/codex-install.log 2>&1; then
        bashio::log.info "Codex CLI installed persistently."
    else
        bashio::log.warning "Failed to install Codex CLI persistently; see /tmp/codex-install.log. Falling back to bundled version."
    fi
else
    bashio::log.info "Persistent Codex CLI already present; skipping install."
fi

API_KEY="$(bashio::config 'openai_api_key')"
if [ -n "${API_KEY}" ]; then
    if [ ! -f "${HOME_DIR}/auth.json" ]; then
        if HOME="${HOME_DIR}" echo "${API_KEY}" | codex login --with-api-key >/tmp/codex-login.log 2>&1; then
            bashio::log.info "Codex CLI authenticated using provided API key."
        else
            bashio::log.warning "Failed to authenticate Codex CLI with provided API key. Check /tmp/codex-login.log for details."
        fi
    else
        bashio::log.info "Auth credentials already present; skipping automatic login."
    fi
fi

AGENTS_FILE="${HOME_DIR}/AGENTS.md"
if [ ! -f "${AGENTS_FILE}" ]; then
    cat <<'EOF' > "${AGENTS_FILE}"
# Codex Agent: Home Assistant Co-pilot

You are Codex running inside a Home Assistant add-on. Primary goals:

- Help inspect and modify Home Assistant configuration files (YAML, templates, integrations, blueprints).
- Review and reason about Home Assistant logs, automations, scripts, and UI dashboards.
- Suggest safe changes, highlighting any placeholders or secrets users must fill in.
- When writing YAML automations, always include triggers, conditions, and actions with valid entity/service names.
- Call out potential risks for device control, restarts, or destructive commands.
- Provide shell commands only when explicitly requested, and default to explanations otherwise.

Important directories:
- `/config`: Home Assistant configuration root.
- `/share`, `/media`, `/ssl`: shared data.

When uncertain, ask clarifying questions before proposing changes.
EOF
    chmod 600 "${AGENTS_FILE}"
fi
