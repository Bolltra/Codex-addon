#!/usr/bin/with-contenv bashio
set -euo pipefail

PORT=7681

export NPM_CONFIG_PREFIX="/config/codex/.npm-global"
export NPM_CONFIG_CACHE="/config/codex/.npm-cache"
export PATH="${NPM_CONFIG_PREFIX}/bin:${PATH}"

if ! command -v ttyd >/dev/null 2>&1; then
    bashio::log.fatal "ttyd is missing inside the container."
    exit 1
fi

TTY_CMD="/bin/bash"
TTY_ARGS=""

FULL_AUTO=""
if bashio::config.true 'full_auto'; then
    FULL_AUTO=" --full-auto"
    bashio::log.warning "Full auto mode enabled – Codex will execute commands without approval."
fi

START_MODE="$(bashio::config 'start_mode')"
CMD="codex${FULL_AUTO}"
if [ "${START_MODE}" = "resume" ]; then
    CMD="codex resume${FULL_AUTO}"
    bashio::log.info "Start mode set to resume – presenting session picker." 
fi

if command -v codex >/dev/null 2>&1; then
    bashio::log.info "Starting Codex Terminal (ttyd) on port ${PORT} with Codex CLI.${FULL_AUTO:+ Full auto mode active.}" 
    exec ttyd --writable -p "${PORT}" -i 0.0.0.0 /bin/bash -lc "cd /config && ${CMD}"
else
    bashio::log.warning "codex CLI not found in PATH; launching shell in /config."
    exec ttyd --writable -p "${PORT}" -i 0.0.0.0 /bin/bash -lc "cd /config && exec /bin/bash"
fi
